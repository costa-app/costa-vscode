name: Sync costa-cli binaries

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to sync (e.g., v0.0.1-alpha.11)'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      REPO: costa-app/costa-cli
      GH_TOKEN: ${{ secrets.PR_CREATOR_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PR_CREATOR_TOKEN }}
          fetch-depth: 0

      - name: Ensure required tools are available
        run: |
          set -euo pipefail
          gh --version

      - name: Download release assets
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.event.inputs.tag }}"
          echo "Downloading assets for tag: $TAG"
          rm -rf tmp/cli
          mkdir -p tmp/cli
          gh release download "$TAG" -R "$REPO" -D tmp/cli
          echo "Downloaded assets:" && ls -la tmp/cli

      - name: Extract archives (no overwrites)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf tmp/cli/extracted
          mkdir -p tmp/cli/extracted
          shopt -s nullglob

          for f in tmp/cli/*.tar.gz tmp/cli/*.tgz; do
            base="$(basename "$f")"
            # Make a unique directory per archive to avoid overwriting costa/README/LICENSE etc.
            dir="tmp/cli/extracted/${base%.tar.gz}"
            dir="${dir%.tgz}"
            echo "Extracting $f -> $dir"
            mkdir -p "$dir"
            tar -xzf "$f" -C "$dir"
          done

          # Also copy any bare binary uploaded directly
          if [ -f tmp/cli/costa ]; then
            mkdir -p tmp/cli/extracted/bare
            cp tmp/cli/costa tmp/cli/extracted/bare/
          fi
          if [ -f tmp/cli/costa.exe ]; then
            mkdir -p tmp/cli/extracted/bare
            cp tmp/cli/costa.exe tmp/cli/extracted/bare/
          fi

          echo "Extracted contents:"
          find tmp/cli/extracted -maxdepth 3 -type f -ls

      - name: Locate platform binaries
        id: locate
        shell: bash
        run: |
          set -euo pipefail

          MAC_BIN="$(
            find tmp/cli/extracted -type f -name 'costa' \
              -path '*darwin*' \
              -exec sh -c 'file -b "$1" | grep -qi "Mach-O" && echo "$1"' _ {} \; \
            | head -n1 || true
          )"

          LINUX_AMD64_BIN="$(
            find tmp/cli/extracted -type f -name 'costa' \
              -path '*linux*amd64*' \
              -exec sh -c 'file -b "$1" | grep -qi "ELF" && echo "$1"' _ {} \; \
            | head -n1 || true
          )"

          LINUX_ARM64_BIN="$(
            find tmp/cli/extracted -type f -name 'costa' \
              -path '*linux*arm64*' \
              -exec sh -c 'file -b "$1" | grep -qi "ELF" && echo "$1"' _ {} \; \
            | head -n1 || true
          )"

          WINDOWS_AMD64_BIN="$(
            find tmp/cli/extracted -type f -name 'costa.exe' \
              -path '*windows*amd64*' \
              | head -n1 || true
          )"

          WINDOWS_ARM64_BIN="$(
            find tmp/cli/extracted -type f -name 'costa.exe' \
              -path '*windows*arm64*' \
              | head -n1 || true
          )"

          echo "mac=$MAC_BIN"                     >> "$GITHUB_OUTPUT"
          echo "linux_amd64=$LINUX_AMD64_BIN"     >> "$GITHUB_OUTPUT"
          echo "linux_arm64=$LINUX_ARM64_BIN"     >> "$GITHUB_OUTPUT"
          echo "windows_amd64=$WINDOWS_AMD64_BIN" >> "$GITHUB_OUTPUT"
          echo "windows_arm64=$WINDOWS_ARM64_BIN" >> "$GITHUB_OUTPUT"

          echo "Detected binaries:"
          echo "mac:           $MAC_BIN"
          echo "linux_amd64:   $LINUX_AMD64_BIN"
          echo "linux_arm64:   $LINUX_ARM64_BIN"
          echo "windows_amd64: $WINDOWS_AMD64_BIN"
          echo "windows_arm64: $WINDOWS_ARM64_BIN"

      - name: Install binaries into res/bin
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p res/bin/darwin-universal res/bin/linux-x64 res/bin/linux-arm64 res/bin/win32-x64 res/bin/win32-arm64

          if [ -n "${{ steps.locate.outputs.mac }}" ]; then
            cp "${{ steps.locate.outputs.mac }}" res/bin/darwin-universal/costa
            chmod +x res/bin/darwin-universal/costa
          fi

          if [ -n "${{ steps.locate.outputs.linux_amd64 }}" ]; then
            cp "${{ steps.locate.outputs.linux_amd64 }}" res/bin/linux-x64/costa
            chmod +x res/bin/linux-x64/costa
          fi

          if [ -n "${{ steps.locate.outputs.linux_arm64 }}" ]; then
            cp "${{ steps.locate.outputs.linux_arm64 }}" res/bin/linux-arm64/costa
            chmod +x res/bin/linux-arm64/costa
          fi

          if [ -n "${{ steps.locate.outputs.windows_amd64 }}" ]; then
            cp "${{ steps.locate.outputs.windows_amd64 }}" res/bin/win32-x64/costa.exe
          fi

          if [ -n "${{ steps.locate.outputs.windows_arm64 }}" ]; then
            cp "${{ steps.locate.outputs.windows_arm64 }}" res/bin/win32-arm64/costa.exe
          fi

          echo "Resulting bin tree:"
          find res/bin -maxdepth 2 -type f -ls || true

      - name: Fail if no binaries were installed
        shell: bash
        run: |
          set -euo pipefail
          count=$(find res/bin -type f \( -name 'costa' -o -name 'costa.exe' \) | wc -l | tr -d ' ')
          if [ "$count" -eq 0 ]; then
            echo "No binaries installed under res/bin. Aborting." >&2
            exit 1
          fi

      - name: Create pull request with updated binaries
        uses: costa-app/create-pull-request@v5
        with:
          token: ${{ secrets.PR_CREATOR_TOKEN }}
          commit-message: 'chore: sync costa-cli ${{ github.event.inputs.tag }} binaries'
          title: 'chore: sync costa-cli ${{ github.event.inputs.tag }} binaries'
          body: |
            Auto-updated from costa-app/costa-cli release `${{ github.event.inputs.tag }}`.

            - Synced macOS, Linux, and Windows binaries
            - Binaries placed under `res/bin/` as expected by the extension
          branch: 'chore/sync-cli-${{ github.event.inputs.tag }}'
          add-paths: |
            res/bin/**
